<html>
  <head>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <form id="checkform">
      <input name="siteUrl" value="https://calleconomydrainclean.com" />
      <button>Start</button>
    </form>
    <button id="stop-btn">Stop</button>
    <div id="result"></div>
    <pre id="job-data" class="d-none"></pre>
    <script>
      let job = null;

      const blinker = `<svg height="16" width="16" class="blinking"><circle cx="8" cy="8" r="8" fill="red" /></svg>`;

      function onSubmit(e) {
        e.preventDefault();
        localStorage.setItem('siteUrl', e.target.siteUrl.value);

        fetch(`/checklinks?siteUrl=${encodeURIComponent(e.target.siteUrl.value)}`)
          .then((r) => r.json())
          .then((r) => {
            job = r;
            displayResult(r);
            $jobData.innerText = JSON.stringify(r, null, 2);
            startPolling();
          });
      }

      let pollInt;

      function startPolling() {
        stopPoll();
        pollInt = setInterval(doPoll, 2000);
      }

      const $result = document.getElementById('result');

      function displayResult(r) {
        const cities = Object.keys(r.result?.test ?? {})
          .map((url) => ({ url, ...r.result.test[url] }))
          .sort((a, b) => (a.url < b.url ? -1 : a.url > b.url ? 1 : 0));

        const htm = cities.map((city) => {
          return `
            <tr>
                <td><a href="${city.url}">${city.url}</a></td>
                <td class="status_${city.status}">${city.status} ${city.status === 'running' ? blinker : ''}</td>
            </tr>
            ${showErrors(city)}
        `;
        });

        let elapsed = '0:00';
        if (r.started) {
          const startDate = new Date(Date.parse(r.started));
          const dif = Date.now() - startDate.getTime();
          const s = dif / 1000;
          const ss = ~~(s % 60);
          const mm = ~~(s / 60);
          elapsed = `${mm}:${ss.toFixed(0).padStart(2, '0')}`;
        }

        $result.innerHTML = `<div class="p-1">Status: ${r?.status ?? 'loading...'} | Time Elapsed: ${elapsed}</div>
        <table border="1" class="w-100"><tbody>${htm.join('')}</tbody></table>`;
      }

      function showErrors(city) {
        const errs = city?.result?.redirects?.filter((r) => r.redirected === true) ?? [];
        if (errs.length > 0) {
          return `
          <tr>
            <td colspan="2">
                <table border="1" class="errors-table">
                    <tbody>
                        ${city?.result?.redirects
                          ?.filter((r) => r.redirected === true)
                          .map((r) => {
                            return `
                            <tr>
                                <td><a href="${r.from}">${r.from}</a></td>
                                <td>=></td>
                                <td><a href="${r.to}">${r.to}</a></td>
                            </tr>`;
                          })
                          .join('')}
                    </tbody>
                </table>
            </td>
        </tr>`;
        }
        return '';
      }

      const $jobData = document.getElementById('job-data');

      function doPoll() {
        fetch(`/job/${job.id}`)
          .then((r) => r.json())
          .then((r) => {
            localStorage.setItem('jobData', JSON.stringify(r));
            $jobData.innerText = JSON.stringify(r, null, 2);
            displayResult(r);
            if (r.status === 'idle') stopPoll();
          });
      }

      function stopPoll() {
        if (pollInt) clearInterval(pollInt);
      }

      const $form = document.getElementById('checkform');
      $form.addEventListener('submit', onSubmit);

      function stopJob() {
        fetch(`/job/${job.id}/stop`)
          .then((r) => r.json())
          .then((r) => {
            $jobData.innerText = JSON.stringify(r, null, 2);
          });
      }

      const $stopBtn = document.getElementById('stop-btn');
      $stopBtn.addEventListener('click', stopJob);

      document.querySelector('input[name="siteUrl"]').value = localStorage.getItem('siteUrl');

      const jobData = localStorage.getItem('jobData');
      if (jobData) {
        job = JSON.parse(jobData);
        console.log({ job });
        displayResult(job.id);
        startPolling();
      }
    </script>
  </body>
</html>
